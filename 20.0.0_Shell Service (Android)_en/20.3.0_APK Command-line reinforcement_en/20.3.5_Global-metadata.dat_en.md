## Solution Overview

To improve the security and execution efficiency, most Unity games in the market abandon C#-based Mono and choose native code-based IL2CPP. Although native code makes cracking more difficult, cheat developers still can use Il2CppDumper and the `global-metadata.dat` file of the game to restore all symbol and string information of `libil2cpp.so`. If you google keywords such as "il2cpp" and "cracking", you will find a bunch of tutorials.
For Il2CppDumper, Shell Service Solution v2.6 provides the `global-metadata.dat` reinforcement feature to reinforce IL2CPP games automatically with no additional manual operations required, which makes cracking much more difficult. Currently, v2.6 has been connected to over 10 blockbuster mobile games with no data exceptions caused.
To further improve the `global-metadata.dat` reinforcement effect, ACE has launched the `global-metadata.dat` runtime decryption feature, **which provides secondary encryption for certain key data based on the existing `global-metadata.dat` reinforcement feature**, to ensure that `global-metadata.dat` of the game runtime is always encrypted. You only need to provide the symbol file generated along with `libil2cpp.so` to enable this feature.

**Notes**

1. You need the symbol table of `libil2cpp.so` to use the runtime decryption feature and only the address of the IL2CPP engine function for reinforcement. **No functions related to the game logic are involved.**
2. The runtime decryption feature supports the following Unity versions. During reinforcement, the Unity version will be automatically identified and processed. This feature isn't available for unsupported versions.

|Unity Version | Supported? | Unity Version | Supported? |
|---|--- | ---- | ---- |
|5.3.x | × | 2017.4.x | √ |
|5.4.x | × | 2018.1.x | √ |
|5.5.x | √ | 2018.2.x | √|
|5.6.x | √ | 2018.3.x | √|
|2017.1.x | √ | 2018.4.x | √|
|2017.2.x | √ | 2019.1.x | √|
|2019.2.x | √ | 2020.2.0-2020.2.19 | √|
|2019.3.x | √ | 2020.2.20- | √|
|2019.4.x | √ | 2021.x |√|
|2020.1.x | √ | |

3. After reinforcement, please amply **test the game features** in **normal game battles** to ensure that each feature is normal.

## Directions

### Enablement method

The lowest version of the command line-based reinforcement tool supporting the runtime decryption feature is v2.7.0. If your tool is below this version, please upgrade it. Click [here](/#/tool-center) to download the latest version.

Perform the following two steps to use the runtime decryption feature:

1. Configure the lowest version `3.3.0.17246.oversea` in `tpshell-config.xml` and enable `enable_globalmetadata_enc` and enable `enc_entire_globalmetadata`.
    ```xml
    <TPVersion>3.3.0.17246.oversea</TPVersion>

    <!--Encryption configuration for globalmetadata-->
    <EncSo>libil2cpp.so</EncSo>；
    <extparams>{
    "enable_globalmetadata_enc":true, 
    "enc_entire_globalmetadata":true}
    </extparams>
    ```

2. Add the `-s` parameter to specify the `symbols.zip` file for the APK/AAB when running the command line-based reinforcement tool. For more information on the `symbols.zip` file, please see `symbols.zip` File Format and Generation Method.
   ```bash
    # How to call the command line-based reinforcement tool to reinforce an APK:
    ClientConsole.exe -d <gameId> <apkpath> <outDir> <certPath> -c 
    <configPath> -s <symbolpath>

    # How to call the command line-based reinforcement tool to reinforce an AAB:
    ClientConsole.exe -a <gameId> <aabPath> <outDir> <certPath> -c 
    <configPath> -s <symbolpath>
    ```

The command line-based reinforcement tool supports the `global-metadata.dat` runtime decryption feature. For the detailed directions, please see [Command Line-Based Reinforcement Tool Guide](/#/doc-center/665803a46e549f4ae4c401e7b36bb13c57639823).
    
### Disablement method

If the `-s` parameter is deleted when the command line-based reinforcement tool runs, the `global-metadata.dat` runtime decryption feature will be disabled by default, and the `global-metadata.dat` file will be encrypted only.

### Verification method

Use a hexadecimal editor to open the reinforced `global-metadata.dat` file. If the first four bytes are 95, 43, 72, and 11 or 94, 43, 72, and 11, and the game runs normally, the runtime decryption feature has been enabled successfully as shown below:

![](/docs/ACE-doc/20_Android-shellservice/30/50/1.png )

## `symbols.zip` File Format and Generation Method

### `symbols.zip` file format

The format of the `symbols.zip` is as shown below. The root directory contains the architecture directories of the APK, and each architecture directory contains a `libil2cpp.sym` file (**the names of .sym files generated by different versions are different, and thus should all be changed to `libil2cpp.sym` during use**) of the corresponding architecture.

![](/docs/ACE-doc/20_Android-shellservice/30/50/2.png )

### symbols.zip file generation method

The generation method of the `symbols.zip` file varies by Unity version. For supported Unity versions, there are three methods of generating this file. Please generate it based on the Unity version and **`symbols.zip` file generation method mapping table**. Here, the generated `libil2cpp.sym.so`, `libil2cpp.so.sym`, and `libil2cpp.so.debug` files can all be directly renamed `libil2cpp.sym`, which has no impact on reinforcement as shown below:

| Unity Version | symbols.zip file generation method |
| ----- | ------|
| 5.5.x （5.5.0 ~ 5.5.6） | Method 3 |
| 5.6.x （ 5.6.0 ~ 5.6.4 ）| Method 3 |
| 5.6.x （ 5.6.5 ~ 5.6.7） | Method 1 |
| 2017 （2017.1.0 ~ 2017.1.2 ）| Method 3 |
| 2017 （2017.1.3 ~ 2017.4.40） | Method 1 |
| 2018 （2018.1.0 ~ 2018.4.12） | Method 1 |
| 2018 （2018.4.13 ~ 2018.4.32） | Method 2 |
| 2019 （2019.1.0 ~ 2019.2.10） | Method 1 |
| 2019 （2019.2.11 ~ 2019.4.21） | Method 2 |
| 2020 （2020.1.0 ~ 2020.2.20） | Method 2 |

* **Method 1: generate a `symbols.zip` file along with the APK after it is built**

![](/docs/ACE-doc/20_Android-shellservice/30/50/4.jpg )

* **Method 2: select the `Create symbols.zip` option first and generate the `symbols.zip` file along with the APK after it is built**

![](/docs/ACE-doc/20_Android-shellservice/30/50/5.jpg )

* **Method 3: keep the project opened, find `libil2cpp.so.debug` under the `Temp\StagingArea\libs` directory, and manually generate `symbols.zip` according to the format requirements**

![](/docs/ACE-doc/20_Android-shellservice/30/50/6.jpg )

## Reinforcement Effect

Before reinforcement, open the `global-metadata.dat` file in a hexadecimal editor as shown below:

![](/docs/ACE-doc/20_Android-shellservice/30/50/7.jpg )

After reinforcement, open the `global-metadata.dat` file in a hexadecimal editor as shown below:

![](/docs/ACE-doc/20_Android-shellservice/30/50/8.jpg )

Dump the `global-metadata.dat` file from the memory and open it in the hexadecimal editor as shown below:

![](/docs/ACE-doc/20_Android-shellservice/30/50/9.0.jpg )

As can be seen from the comparison between the above reinforcement results, although the header of the `global-metadata.dat` file dumped from the memory has been cracked, part of the data still remains encrypted, and the `global-metadata.dat` and `libil2cpp.so` files generated by Il2CppDumper will be exceptional when used as shown below:

![](/docs/ACE-doc/20_Android-shellservice/30/50/9.1.jpg )

## Unity Version Compatibility Test

| Unity Version | Supported? | Unity Version | Supported? |
| ---|--- | ---- | ---- |
| 5.5.0 | √  | 2018.4.31 | √ |
| 5.5.6 | √  | 2019.1.0 | √  |
| 5.6.0 | √ | 2019.3.0 | √ |
| 5.6.7 | √ | 2019.3.6 | √ |
| 2017.1.0 | √ | 2019.3.7 | √ |
| 2017.4.15 | √ | 2019.4.10 | √ |
| 2017.4.40 | √ | 2019.4.11 | √ |
| 2018.1.0 | √ | 2019.4.14 | √ |
| 2018.2.20| √ | 2019.4.15 | √ |
| 2018.3.1 | √ | 2019.4.20 | √ |
| 2018.4.20 | √  | 2020.1.0 | √ |
| 2018.4.27 | √  | 2020.1.17 | √ | 

## Compatibility Test

* The compatibility has been tested and approved in two large mobile games on top 100 mobile phone models.
* The compatibility has been tested and approved in demos of different Unity versions on top 300 mobile phone models.

## Performance Test

In a mobile game, the size of `libil2cpp.so` is 103 MB, and the size of `global-metadata.dat` is 30.1 MB. Their memory usage on Pixel 3 XL and Nexus 5 is as shown below:

| Machine | System Version | case | First | Second | Third |
| ---- | ----- | ------ | ------| ------| ------|
| pixel3 xl | android 10.0 | so, dat shelled | 328MB | 327MB | 329MB |
| pixel3 xl | android 10.0 | so shelled、dat not shelled| 323MB | 323MB | 324MB |
| pixel3 xl | android 10.0 | so、dat not shelled | 285MB | 285MB | 285MB |
| nexus5 | android 5.1 | so, dat shelled | 293MB | 291MB | 292MB |
| nexus5 | android 5.1 | so shelled、dat not shelled | 283MB | 284MB | 283MB |
| nexus5 | android 5.1 | so、dat not shelled | 248MB | 243MB | 245MB |
